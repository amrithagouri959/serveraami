{% extends 'emp/base.html' %}
{% block title %}Page M{{ page_id }}{% endblock %}

{% block content %}
<div class="text-center">
    <h1>You selected M{{ page_id }}</h1>

    <!-- Large container box with border -->
    <div class="bordered-container p-4">
        <div class="complaints-box p-4">
            <!-- Buttons for selecting a complaint arranged in columns and rows -->
            <div class="container">
                <div class="row">
                    {% for i in complaints %}
                    <div class="col-md-4 mb-1">
                        <!-- Each column is a complaint button -->
                        <div class="complaint-container">
                            <button class="btn btn-dark-red w-100 d-flex justify-content-between align-items-center complaint-btn" data-complaint="complaint{{ i }}">
                                Complaint {{ i }}
                                <span class="text-success">&#x2192;</span>
                            </button>
                            <div class="issues-list" id="complaint{{ i }}" style="display: none;">
                                <div class="d-flex justify-content-center">
                                    <ul class="list-group cute-list w-100">
                                        <li class="list-group-item cute-list-item" data-issue="Issue 1">Issue 1</li>
                                        <li class="list-group-item cute-list-item" data-issue="Issue 2">Issue 2</li>
                                        <li class="list-group-item cute-list-item" data-issue="Issue 3">Issue 3</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Back Button below the complaints box -->
        <div class="mb-4 mt-4">
            <a href="{% url 'emp:machine_selection' %}" class="btn btn-secondary">Back</a>
        </div>

        <!-- Modal for confirmation -->
        <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirmationModalLabel">Confirm Selection</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Are you sure you want to proceed with Complaint: <span id="selectedComplaint"></span> and Issue: <span id="selectedIssue"></span>?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="confirmButton">OK</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CSS for Dark Red Button, Rectangular Issues List, and Page Border -->
<style>
    .btn-dark-red {
        background-color: #8B0000;
        color: white;
        border: 2px solid #A52A2A;
    }

    .btn-dark-red:hover {
        background-color: #A52A2A;
    }

    .complaint-container {
        position: relative;
        margin-bottom: 10px;
    }

    .issues-list {
        display: none;
        background-color: #f2f2f2;
        border: 2px solid #ff4500;
        border-radius: 8px;
        padding: 10px;
        width: 100%;
        z-index: 1000;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        max-height: 200px;
        overflow-y: auto;
        position: absolute;
        top: 100%;
        left: 0;
    }

    .cute-list {
        padding: 0;
        list-style: none;
        margin: 0;
    }

    .cute-list-item {
        background-color: #fff5f5;
        border-radius: 8px;
        margin: 5px 0;
        padding: 15px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
        display: block;
        text-align: center;
        border: 1px solid #ddd;
    }

    .cute-list-item:hover {
        background-color: #ffe5e5;
        transform: scale(1.02);
    }

    .bordered-container {
        border: 2px solid #ff4500;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        background-color: #fafafa;
        margin: 0 auto;
        max-width: 90%;
    }
</style>

<!-- JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        let selectedComplaint = '';
        let selectedIssue = '';

        // Toggle issue list visibility on button click
        document.querySelectorAll('.complaint-btn').forEach(function (button) {
            button.addEventListener('click', function (event) {
                const complaintId = this.getAttribute('data-complaint');
                const issueList = document.getElementById(complaintId);

                // Hide all issue lists first
                document.querySelectorAll('.issues-list').forEach(function (list) {
                    if (list.id !== complaintId) {
                        list.style.display = 'none';
                    }
                });

                // Toggle visibility for the selected issue list
                if (issueList.style.display === 'block') {
                    issueList.style.display = 'none';
                } else {
                    issueList.style.display = 'block';
                }

                // Update selected complaint
                selectedComplaint = this.textContent.trim();
                document.getElementById('selectedComplaint').textContent = selectedComplaint;

                // Prevent click event from propagating
                event.stopPropagation();
            });
        });

        // Open the modal when an issue is clicked
        document.querySelectorAll('.cute-list-item').forEach(function (item) {
            item.addEventListener('click', function () {
                selectedIssue = this.textContent.trim();
                document.getElementById('selectedIssue').textContent = selectedIssue;

                // Show the confirmation modal
                const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
                confirmationModal.show();
            });
        });

        // Hide all issues lists when clicking outside
        document.addEventListener('click', function (event) {
            if (!event.target.classList.contains('complaint-btn') &&
                !event.target.classList.contains('cute-list-item')) {
                document.querySelectorAll('.issues-list').forEach(function (list) {
                    list.style.display = 'none';
                });
            }
        });

        // Save complaint when confirm button is clicked
        document.getElementById('confirmButton').addEventListener('click', function () {
            fetch("{% url 'emp:save_complaint' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({
                    complaint: selectedComplaint,
                    issue: selectedIssue
                }),
            }).then(response => response.json())
              .then(data => {
                if (data.status === 'success') {
                    window.location.href = '{% url "emp:logout_and_redirect" %}';  // logout on success
                } else {
                    console.error('Failed to save complaint:', data.message);
                }
            }).catch(error => {
                console.error('Error:', error);
            });
        });
    });
</script>

{% endblock %}
